<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
    	<title>YakityChat</title>    
    
        <script src="ppp-js/Base.js" type="text/javascript"></script>
        <script src="ppp-js/utf8.js" type="text/javascript"></script>
        <script src="ppp-js/util.js" type="text/javascript"></script>
        <script src="ppp-js/widget.js" type="text/javascript"></script>
        <script src="ppp-js/mapping.js" type="text/javascript"></script>
        <script src="ppp-js/lambda.js" type="text/javascript"></script>
        <script src="ppp-js/serialization.js" type="text/javascript"></script>
        <script src="ppp-js/meteor.js" type="text/javascript"></script>
        <script src="ppp-js/table.js" type="text/javascript"></script>
        <script src="ppp-js/mmp.js" type="text/javascript"></script>
        <script src="ppp-js/psyc.js" type="text/javascript"></script>
        <script src="mootools-core-1.4.5-full-nocompat.js" type="text/javascript"></script>
        <script src="mootools-more-1.4.0.1-nocompat.js" type="text/javascript"></script>
        <script src="js/yakity.js" type="text/javascript"></script>
        <script src="js/accChat.js" type="text/javascript"></script>

		<script type="text/javascript">
			var client; 
			var error;
			var chat;
			var foo;
			var profiles;
			var userlist;
			var bip;
			var METEORURL = "<meteorurl/>";

			function soundManager() {
			    	if (!bip) return;
			    	
			        var icon = document.getElementById('soundIcon');
				var link = document.getElementById('soundLink');

				if (bip.on) {
				    UTIL.replaceClass(icon, "on", "off");
				    link.title = "Toggle sound on.";
				    bip.on = false;
				} else {
				    UTIL.replaceClass(icon, "off", "on");
				    link.title = "Toggle sound off.";
				    bip.on = true;
				}
			};
			

			function onlink(success, uniform) {
				client.onlink = null;

				if (!success) {
					var error = document.getElementById("linkError");
					var err_node = document.createTextNode(uniform);
					if (error.firstChild) {
						error.replaceChild(err_node, error.firstChild);
					} else {
						error.appendChild(err_node);
					}
					return;
				} else {
				    UTIL.addClass(document.getElementById("link"), "hidden");
				    UTIL.removeClass(document.getElementById("container"), "hidden");
				}

				if (!bip) {
				    //this may fail if plugin support is missing
				    try { 
					bip = new UTIL.Audio({ wav : "sounds/bip.wav", ogg : "sounds/bip.ogg", mp3 : "sounds/bip.mp3", autoplay : false, autobuffer : true, hidden : true });
					if (bip.getDomNode) document.getElementById("bip").appendChild(bip.getDomNode());
					UTIL.replaceClass(document.getElementById("soundIcon"), "no", "on");
					document.getElementById("soundLink").title = "Toggle sound off.";
					bip.on = true;
				    } catch (e) {
					if (meteor.debug) meteor.debug("sound wont work: %o", e);
				    };
				}

				var ulink = function (uniform) {
					if (uniform == client.uniform) return profiles.getDisplayNode(uniform);
					var a = document.createElement("a");
					//a.href = "javascript:void(null)";
					a.title = "Open private chat with "+uniform.name;
					a.appendChild(profiles.getDisplayNode(uniform));
					a.onclick = function() {
						var win = chat.getWindow(uniform);
						chat.active = win;
						chat.accordion.display(win.pos);
					};

					return a;
				};

				var timestamp = (function(type, key, value, p) {
					var div = document.createElement("div");
					div.appendChild(document.createTextNode(value.render("_hours") + ":" + value.render("_minutes") + ":" + value.render("_seconds")));
					return div;
				});
				var userlink = (function(type, key, value, p) {
					if (type) return value.render(type);
					var span = document.createElement("span");
					if (value.is_room()) {
					    span.appendChild(profiles.getDisplayNode(value));
					} else {
					    span.appendChild(ulink(value));
					}
					return span;
				});
				var templates = new mmp.Vars({
					_status_circuit :  Yakity.HtmlTemplate("<h1>Instructions</h1><div class='introDiv'><img src='images/yakgroup.png' align='left'> Room chat icon.</div><div class='introDiv'><img src='images/yakgroup-waiting.png' align='left'> Group chat, unread message waiting.</div><div class='introDiv'><img src='images/member-icon.png' align='left'> Private chat icon.</div><div class='introDiv'><img src='images/member-icon-waiting.png' align='left'> Private chat, unread message.</div><div class='introDiv'><img src='images/sound-on.png' align='left'> Message notification, click to toggle sound on/off.</div>"),
					_notice_context_enter : "[_supplicant] enters [_context].",
					_notice_context_leave : "[_supplicant] leaves [_context].",
					_message_public : "[_timestamp] [_source_relay] [data]",
					_message_private : "[_timestamp] [source] [data]",
					//_message_private : Yakity.HtmlTemplate("<strong>[_timestamp]</strong> [_source_relay] [data]"),
					_source : userlink,
					_supplicant : userlink,
					_timestamp : timestamp
				});
				profiles = new Yakity.ProfileData(client);
		
				var lprofiles = new Yakity.ProfileData(client).extend({
					getDisplayNode : function(uniform) {
						return ulink(uniform);
					}
				});
				
				
				userlist = new Yakity.UserList(client, lprofiles);
				
				var userdiv = document.createElement("div");
                                UTIL.addClass(userdiv, "userList");
                                userdiv.appendChild(userlist.table.table);
				document.getElementById("leftPane").appendChild(userdiv);

				var CustomChat = new Class({
					Extends : AccChat,
					createWindow : function(uniform) {
						var win = this.base(uniform);
						if (uniform.is_room()) {
							win.renderMember = function(uniform) {
								return ulink(uniform);
							}
						}
						win.extend({
							renderMessage : function(p, m) {
								var div = this.base(p, m);

								if (div && p.v("_source_relay") == client.uniform) {
									UTIL.addClass(div, "self");	
								}
								return div;
							},
							_notice_presence_typing : function(p) {
								UTIL.replaceClass(this.header, "idle", "typing");
								UTIL.replaceClass(this.container, "idle", "typing");
								return psyc.STOP;
							},
							_notice_presence_idle : function(p) {
								UTIL.replaceClass(this.container, "typing", "idle");
								UTIL.replaceClass(this.header, "typing", "idle");
								return psyc.STOP;
							},
							_notice_logout : function(p) {
								UTIL.replaceClass(this.container, "idle", "offline");
								UTIL.replaceClass(this.header, "idle", "offline");
								UTIL.replaceClass(this.container, "typing", "offline");
								UTIL.replaceClass(this.header, "typing", "offline");
							},
							_notice_login : function(p) {
								UTIL.replaceClass(this.container, "offline", "idle");
								UTIL.replaceClass(this.header, "offline", "idle");
							}
						});
						if (bip) win.registerEvent("new_message", UTIL.make_method(this, function(win, p, node) {
							if (p.source() == this.client.uniform 
							    || p.v("_source_relay") == this.client.uniform 
							    || ((p.data.isMethod("_notice_enter") || p.data.isMethod("_notice_leave")) && p.data.v("_supplicant") == this.client.uniform)
							    || !bip.on) {
								return;
							}

							window.setTimeout(play_bip, 0);
						}));

						return win;
					}
				});
				chat = new CustomChat(client, templates, "YakityChat", document.chat_input.text);
				chat.idle = new Yakity.Presence.Typing(client, chat);
			}

			var lastbip;
			function play_bip() {
			    	if (!bip) return;
				var t = new Date();
                                if (lastbip && (t.getTime() - lastbip.getTime() < 6660)) {
                                    return;
                                }
                                lastbip = t;
				bip.play();
			}
			function new_input() {
				var str = document.chat_input.text.value;
				var message;
				if (str.length == 0) return false;

				try {
					if (this.chat.active) {
						var win = this.chat.active;
						var target = win.name;
						if (target.is_person()) {
							message = win.sendmsg(target, "_message_private", str, 0, function(p, m) {
								if (m.method == "_notice_echo") {
									message.data = client.message_signature.decode(message.data);
									win._(message, message.data);
								} else if (meteor.debug) meteor.debug("got strange reply to _message_private: %o", p);
							});
						} else {
							win.sendmsg(target, "_message_public", str);
						}
						document.chat_input.text.value = "";
					} else {
						//error_fun("You cannot chat to the DEBUG!");
					}
				} catch (err) {
					meteor.debug("send failed: ".err.toString());
				}
				return false;
			};

			function show_login_prompt() {
			    UTIL.addClass(document.getElementById("connect"), "hidden");
			    UTIL.removeClass(document.getElementById("link"), "hidden");
			};

			function init() {
				if (client) return false;

				client = new Yakity.Client(METEORURL, name);
				client.registerEvent("connect", show_login_prompt);
				client.registerEvent("link", onlink);

				window.onunload = function() {
					if (client) {
						client.logout();
						client.abort();
						client = null;
					}
				};

				return false;
			};

			function link() {
				try {
					var name = document.login.name.value;
					client.link(name);
				} catch (e) {}

				return false;
			};

			meteor.debug = UTIL.log;
			window.addEvent("domready", init);
		</script>
		<link rel="stylesheet" type="text/css" href="screen.css">

</head>
<body>
<div id="bip" style="width:0px; height:0px;"></div>
<div id="content">
	<div id="connect" class=window>
		   <div id="connectError"></div>
		   <div id="connectRequest">
			   Connecting to <meteorurl />.
		   </div> 
	</div>
	<div id="link" class="window hidden">
		   <div id="linkError"></div>
		   <div id="linkRequest">
					<form name="login" onSubmit="return link()">
							<input type="image" src="images/yak.png" name="submit" tabindex="2" class="inputSubmit">
							<input name="name" value="Enter Nickname..." onfocus="this.value=''" size="25" max-length="45" tabindex="1" class="textInput"> 
					</form>
		   </div> 
	</div>
	<div id="container" class="window hidden">
			<div id="leftPane">
				<a href="javascript:void(null)" onclick="soundManager()" title="You browser does not support sound." id="soundLink"><div id="soundIcon" class="no"></div></a>
				<div id="rooms">
						<div class="roomHeader">Available Rooms</div>
						<emit source="chat_rooms">
							<a onclick='return chat.enterRoom(mmp.get_uniform("&_.uniform;"), true);'>&_.name;</a><br>
						</emit>
				</div>
			</div>
			<div id="rightPane">
				<div id="YakityChat"></div>
			</div>
			<div id="basePane">
				<form name=chat_input onSubmit="return new_input()" onKeyDown="return chat.idle.probable_type_event()" onMouseUp="chat.idle.probable_type_event();">
							<div id="inputChats">        
									<input type="image" src="images/yak.png" name="submit" tabindex="2" class="chatSubmit">
					<input name=text value="" size="50" class="chatText" id="chatText" autocomplete="off">
				</div>
				</form>
			</div>
			<div class="basePane" style="float:right;"></div>
			<div class="basePane" style="clear:right;"></div>
	</div>
</div>
<div id="terms">YakityChat&trade; is a trademark owned by Webhaven<sup>&reg;</sup> International ApS, DK<br />
YakityChat&trade; is open source software: <a href="http://yakitychat.com/license.html" target="_blank">License</a></div>
</body>
