<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
    	<title>YakityChat</title>    
    
        <script src="lib/Base.js" type="text/javascript"></script>
        <script src="js/utf8.js" type="text/javascript"></script>
        <script src="js/xss.js" type="text/javascript"></script>
        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/mapping.js" type="text/javascript"></script>
        <script src="js/meteor.js" type="text/javascript"></script>
        <script src="js/table.js" type="text/javascript"></script>
        <script src="js/serialization.js" type="text/javascript"></script>
        <script src="lib/yakity.js" type="text/javascript"></script>
        <script src="lib/accChat.js" type="text/javascript"></script>
        <script src="mootools-1.2.3-core-nc.js" type="text/javascript"></script>
        <script src="mootools-1-1.2.3.1-more.js" type="text/javascript"></script>
        
        
		<script type="text/javascript">
			var client; 
			var error;
			var chat;
			var profiles;
			var userlist;

			function elink(name) {
				var a = document.createElement("a");
				a.href = "javascript:void(null)";
				a.appendChild((typeof(name) == "string") ? document.createTextNode(name) : name);
				return a;
			}

			function onconnect(success, uh) {
				client.onconnect = null;
				if (!success) {
					document.getElementById("connectError").appendChild(document.createTextNode(uh));
					client = null;
					return;
				} else {
					document.getElementById("connect").style.display = "none";
					document.getElementById("container").style.display = "block";
				}

				var ulink = function (uniform) {
					var div = document.createElement("div");
					div.appendChild(profiles.getDisplayNode(uniform));
					div.onclick = function() {
						var win = chat.getWindow(uniform);
						chat.active = win;
						chat.accordion.display(win.pos);
					};

					return div;
				};

				var timestamp = (function(type, key, value, m) {
					var div = document.createElement("div");
					div.appendChild(document.createTextNode(value.render("_hours") + ":" + value.render("_minutes") + ":" + value.render("_seconds")));
					return div;
				});
				var userlink = (function(type, key, value, m) {
					if (type) return value.render(type);
					if (value.is_person()) {
						return ulink(value);
					} else {
						var span = document.createElement("span");
						span.appendChild(profiles.getDisplayNode(value));
						return span;
					}
				});
				var templates = new psyc.Vars({
					_ : "[_source] says: [data]",
					_status_circuit : "Welcome to the chat at [_source-_host].",
					_notice_enter : "[_supplicant] enters [_source].",
					_notice_leave : "[_supplicant] leaves [_source].",
					_message_public : "[_timestamp] [_source_relay] [data]",
					_message_private : "[_timestamp] [_source] [data]",
					_echo_message_public : "[_timestamp] [_source_relay] [data]",
					_echo_message_private : "[_timestamp] [_source_relay] [data]",
					_source : userlink,
					_supplicant : userlink,
					_timestamp : timestamp
				});
				profiles = new psyc.ProfileData(client);
		
				var lprofiles = new psyc.ProfileData(client).extend({
					getDisplayNode : function(uniform) {
						return ulink(uniform);
					}
				});
				
				
				userlist = new psyc.UserList(client, lprofiles);
				
				var userdiv = document.createElement("div");
                                UTIL.addClass(userdiv, "userList");
                                userdiv.appendChild(userlist.table.table);
				document.getElementById("leftPane").appendChild(userdiv);

				var CustomChat = AccChat.extend({
					createWindow : function(uniform) {
						var win = this.base(uniform);
						if (uniform.is_room()) {
							win.renderMember = function(uniform) {
								return ulink(uniform);
							}
						}
						win.extend({
							renderMessage : function(m) {
								var div = this.base(m);
								if (m.vars.get("_source_relay") == client.uniform) {
									UTIL.addClass(div, "self");	
								}
								return div;
							},
						});

						return win;
					}
				});
				chat = new CustomChat(client, templates);

				error = document.createElement("div");
				var errorh = document.createElement("div");
				var errorc = document.createElement("div");
				errorh.appendChild(document.createTextNode("DEBUG"));
				errorc.appendChild(error);
				UTIL.addClass(errorh, "header");
				UTIL.addClass(error, "error");
				document.getElementById("YakityChat").appendChild(errorh);
				document.getElementById("YakityChat").appendChild(errorc);
				chat.accordion.addSection(errorh, errorc, chat.accordion.elements.length);
				chat.accordion.display(0);
				error.style.overflow = "auto";
				meteor.debug = error_fun;
			}

			function init() {
				if (client) return false;

				var name = document.login.name.value;
				client = new psyc.Client("<meteorurl/>", name);
				client.onconnect = onconnect;

				window.onunload = function() {
					if (client) {
						client.close();
						client = null;
					}
				};

				return false;
			};

			function error_fun(str) {
				var text = document.createTextNode(str);
				error.appendChild(text);
				error.appendChild(document.createElement("br"));
				error.scrollTop = error.scrollHeight;
			};

			function atom() {
				var str = document.chat_input.text.value;
				if (str.length == 0) return false;

				try {
					if (this.chat.active) {
						var target = this.chat.active.name;

						var vars = new psyc.Vars("_target", target);
					 
						var p = new psyc.Message( target.is_person() ? "_message_private" : "_message_public", vars, str);
						this.client.send(p);
						document.chat_input.text.value = "";
					} else {
						error_fun("You cannot chat to the DEBUG!");
					}
				} catch (err) {
					meteor.debug("send failed: ".err.toString());
				}
				return false;
			};

		</script>
		<style type="text/css">
			body {
				font-family: 'Andale Mono', FreeSans, sans-serif;
				margin: 0;
				margin-top: 10px;
				background-color: #007fc2;
			}
                        
			#chathaven {
				margin: 0; 
			}

			div.header a {
				text-align: right;
			}

			div.toggler {
				font-size: 9pt;
				font-family: 'Andale-Mono', sans-serif;
				display: block;
				width: 340px;
				height: 24px;
			}

			div.error {
				font-family: monospace;
				font-size: small;
				height: 400px;
				color: black;
				overflow:auto;
			}

                        div._notice_enter div._supplicant, div._notice_leave div._supplicant {
                                float: left;
                                margin-right: 3px;
                        }
                        
			div.status div.messages, div.public div.messages {
				height: 400px;
				overflow: auto;
				border-bottom: 1px #ccc solid;	
			}

			div.private div.messages {
				height: 400px;
				overflow: auto;
				border-bottom: 1px #ccc solid;	
			}
			
                        div.chatwindow {
				background-color: #dddddd;
				border-right: 1px #ccc solid;
				border-left: 1px #ccc solid;
				position: relative;
			}
			
                        
			div.membersList
			{
				height: 200px;
				width: 50%;
				background-color: #fdffc4;
				opacity:0.6;
				filter:alpha(opacity=60);
				overflow: auto;
				position:absolute;
				top: 0px;
				right: 0px;
			}
			
			div.membersList table {
			        width: 100%;
			}
			
			div.membersList table th {
			        font-size: 10pt;
			}
			
			div.membersList table td {
			        font-size: 8pt;
			        text-align: right;
			        padding-right: 15px;
			}
			
			div.membersList table tbody div {
                                cursor: pointer;
                                cursor: hand;
                                color: #528CE0;
			}

                        div.private div.toggleInfo {
                                width: 25px;
                                height: 24px;
                                line-height: 24px;
                                float:left;
                                background: url(images/member-icon.png);
				background-position: center center;
				background-repeat: no-repeat;
                        }
                        
                        div.public div.toggleInfo {
                                width: 25px;
                                height: 24px;
                                line-height: 24px;
                                float:left;
                                background: url(images/group-icon.png);
				background-position: center center;
				background-repeat: no-repeat;
                        }
			

			div.left div.roomchat {
				background-color: #aaa;
			}

			div.header {
				cursor: pointer;
				height: 25px;
				line-height: 25px;
				border-right: 1px #ccc solid;
				border-left: 1px #ccc solid;
				border-top: 1px #FFF solid;
				border-bottom: 1px #999 solid;
				font-family: 'Andale Mono', FreeSans, sans-serif;
				font-size: 9pt;
				background: url(images/yakitytab.gif);
				color: #528CE0;
				margin: 0;
				padding: 3px 5px 1px;
			}

                        
                        div.closeButton, div.leaveButton, div.enterButton {
                                display: block;
				width: 20px;
				height: 24px;
				line-height: 24px;
				float: right;
                        }
                        
                        div.closeButton {
				background: url(images/cross-icon-red.png);
				background-position: center center;
				background-repeat: no-repeat;
                        }
                        
                        div.joined div.closeButton {
                                display: none;
                        }
                        
                        div.leaveButton {
				background: url(images/cross-icon-grey.png);
				background-position: center center;
				background-repeat: no-repeat;
                        }
                        
                        div.left div.leaveButton {
                                display: none;
                        }
                        
                        div.enterButton {
				background: url(images/yak-icon.png);
				background-position: center center;
				background-repeat: no-repeat;
                        }
                        
                        div.joined div.enterButton {
				display: none;
                        }
                        

			span._user_realname {
				color: #00f;
				font-variant: small-caps;
			}

			
			div._ {
                                font-family: 'Andale Mono', FreeSans, sans-serif;
				color: #000;
				font-size: 9pt;
				line-height: 120%;
			}

                        div._timestamp {
                                float: right;
                                font-size: 8pt;
                                color: #999;
                                margin-right: 5px;
                        }

                        div._echo_message_private {
                                padding: 5px;
                        }
                        
			div._message, div._notice {
				text-decoration: none;
                                color: #999; 
                                padding: 5px;
			}
			
			div._message .data {
                                color: #000;
                                white-space: -moz-pre-wrap;
                                white-space: -pre-wrap;
                                white-space: -o-pre-wrap;
                                white-space: pre-wrap;
                                word-wrap: break-word;
			}
			
			div._supplicant, div._source {
				color: #528CE0;
                                font-weight: bold;
                                text-decoration: none;
                                cursor: pointer;
                                cursor: hand;
			}
			
			div.self div._source_relay {
				color: #000;
                                font-weight: bold;
                                text-decoration: none;
			}
			
			
			br.clearall {
				clear:both;
			}
			
			input.chattext {
				width: 95%;
			}
                        
			#container {
                                width: 780px;
                                position: relative;
                                margin: 0px auto 0px auto;
                                background: #fff;
                                border: 2px solid #555;
                                -moz-border-radius-topleft: 10px;
                                -webkit-border-top-left-radius: 10px;
                                border-top-left-radius: 10px;
			}
			
			#leftPane {
			        min-height: 155px;
                                width: 50%;
                                position: relative;
                                float:left;
                                background-image: url(images/yakitychat.png);
                        	background-repeat: no-repeat;
                        	background-position: 10px 10px;
			}
			
			#rightPane {
                                width: 50%;
                                position: relative;
                                float:right;
			}
			
			#rooms {
                                padding: 20px;
                                margin-left: 200px;
			}
			
			#basePane {
                                height: 50px;
                                background: #efefef;
                                line-height: 50px;
                                padding: 20px;
                                clear:both;
                                -moz-border-radius-bottomright: 10px;
                                -webkit-border-bottom-right-radius: 10px;
                                border-bottom-right-radius: 10px;
                                -moz-border-radius-bottomleft: 10px;
                                -webkit-border-bottom-left-radius: 10px;
                                border-bottom-left-radius: 10px;
                                
			}
			
			.basePane {
                                -moz-border-radius-bottomright: 10px;
                                -webkit-border-bottom-right-radius: 10px;
                                border-bottom-right-radius: 10px;
                                -moz-border-radius-bottomleft: 10px;
                                -webkit-border-bottom-left-radius: 10px;
                                border-bottom-left-radius: 10px;
                                
			}
                        
                        #connect {
                                position: relative;
                                width: 500px;
                                padding: 10px;
                                margin-left: auto;
                                margin-right: auto;
                                background: #fff;
                                border: 2px solid #555;
                                -moz-border-radius: 10px;
                                -webkit-border-radius: 10px;
                                border-radius: 10px;
                        }
                        
                        
                        #connect input {
                                float:right; 
                                margin-top: 55px;
                        }
                        
                        #connect .textInput {
                        
                                height: 26px; 
                                width: 300px; 
                                font-size: 16pt; 
                                margin-right: 10px;
                        }
                        
                        #connectRequest
                        {
                                height: 145px;
                                line-height: 145px;
                                padding-left: 135px;
                        	background-image: url(images/yakitychat.png);
                        	background-repeat: no-repeat;
                        	background-position: left 0px;
                        }
                        
                        .terms {
                                font-size: 6.5pt;
                                text-align: center;
                                font-family: 'Andale Mono', FreeSans, sans-serif;
                        }
		</style>
</head>
<body>
<div id="container" style="display:none;">
        <div id="leftPane">
			<div id="rooms">
				<select name="chat_rooms" onchange='return chat.enterRoom(psyc.get_uniform(this.value)); this.value=""'>
					<option value="">Available Rooms</option>
				<emit source="chat_rooms">
					<option value="&_.uniform;">&_.name;</option>
				</emit>
				</select>
			</div>
        </div>
        <div id="rightPane">
			<div id="YakityChat"></div>
        </div>
        <div id="basePane">
			<form name=chat_input onSubmit="return atom()">
				<input name=text value="" size="50" class="chattext">
			</form>
        </div>
        <div class="basePane" style="float:right;"></div>
        <div class="basePane" style="clear:right;"></div>
</div>
<div id="connect">
       <div id="connectError"></div>
       <div id="connectRequest">
                <form name="login" onSubmit="return init()">
                        <input type="image" src="images/yak.png" name="submit" tabindex="2" class="inputSubmit">
                        <input name="name" value="Enter Nickname..." onfocus="this.value=''" size="25" max-length="45" tabindex="1" class="textInput"> 
                </form>
       </div> 
       <div class="terms">YakityChat&trade; is a trademark owned by Webhaven<sup>&reg;</sup> International ApS, DK<br />
YakityChat&trade; is open source software: <a href="http://yakitychat.com/aboutyakitychat.html?mode=display&amp;section_id=&amp;parent_id=0&amp;content_id=279&amp;id=279">License</a></div>
</div>
</body>
