<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
    	<title>chathaven</title>    
    
        <script src="lib/Base.js" type="text/javascript"></script>
        <script src="js/utf8.js" type="text/javascript"></script>
        <script src="js/xss.js" type="text/javascript"></script>
        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/mapping.js" type="text/javascript"></script>
        <script src="js/meteor.js" type="text/javascript"></script>
        <script src="js/table.js" type="text/javascript"></script>
        <script src="js/serialization.js" type="text/javascript"></script>
        <script src="lib/yakity.js" type="text/javascript"></script>
        <script src="lib/accChat.js" type="text/javascript"></script>
		<script src="mootools-1.2.3-core-nc.js" type="text/javascript"></script>
		<script src="mootools-1-1.2.3.1-more.js" type="text/javascript"></script>
        
        
		<script type="text/javascript">
			var client; 
			var error;
			var chat;
			var profiles;
			var userlist;

			function elink(name) {
				var a = document.createElement("a");
				a.href = "javascript:void(null)";
				a.appendChild((typeof(name) == "string") ? document.createTextNode(name) : name);
				return a;
			}

			function onconnect(success, uh) {
				client.onconnect = null;
				if (!success) {
					document.getElementById("connectError").appendChild(document.createTextNode(uh));
					client = null;
					return;
				} else {
					document.getElementById("connect").style.visibility = "hidden";
					document.getElementById("container").style.visibility = "visible";
				}

				var userlink = (function(type, key, value, m) {
					if (type) return value.render(type);
					if (value.is_person()) {
						var a = elink(profiles.getDisplayNode(value));
						a.onclick = function() {
							var win = chat.getWindow(value);
							chat.active = win;
							chat.accordion.display(win.pos);
						};
						return a;
					} else {
						return profiles.getDisplayNode(value);
					}
				});
				var templates = new psyc.Vars("_", "[_source] says: [data]",
									  "_status_circuit", "Welcome to the chat at [_source-_host].",
									  "_notice_enter", "[_supplicant] enters [_source].",
									  "_notice_leave", "[_supplicant] leaves [_source].",
									  "_message_public", "[_timestamp-_hours]:[_timestamp-_minutes]:[_timestamp-_seconds] [_source_relay]: [data]",
									  "_message_private", "[_timestamp-_hours]:[_timestamp-_minutes]:[_timestamp-_seconds] [_source]: [data]",
									  "_echo_message_public", "[_timestamp-_hours]:[_timestamp-_minutes]:[_timestamp-_seconds]  [_source_relay]: [data]",
									  "_echo_message_private", "[_timestamp-_hours]:[_timestamp-_minutes]:[_timestamp-_seconds] [data]",
									  "_source", userlink,
									  "_supplicant", userlink
										);
				profiles = new psyc.ProfileData(client);
				userlist = new psyc.UserList(client, profiles);
				document.getElementById("leftPane").appendChild(userlist.table.table);
				chat = new AccChat(client, templates);

				error = document.createElement("div");
				var errorh = document.createElement("div");
				var errorc = document.createElement("div");
				errorh.appendChild(document.createTextNode("DEBUG"));
				errorc.appendChild(error);
				UTIL.addClass(errorh, "header");
				UTIL.addClass(error, "error");
				document.getElementById("chathaven").appendChild(errorh);
				document.getElementById("chathaven").appendChild(errorc);
				chat.accordion.addSection(errorh, errorc, chat.accordion.elements.length);
				chat.accordion.display(0);
				error.style.overflow = "auto";
				meteor.debug = error_fun;
			}

			function init() {
				if (client) return false;

				var name = document.login.name.value;
				client = new psyc.Client("<meteorurl/>", name);
				client.onconnect = onconnect;

				window.onunload = function() {
					if (client) {
						client.close();
						client = null;
					}
				};

				return false;
			};

			function error_fun(str) {
				var text = document.createTextNode(str);
				error.appendChild(text);
				error.appendChild(document.createElement("br"));
				error.scrollTop = error.scrollHeight;
			};

			function atom() {
				var str = document.chat_input.text.value;
				if (str.length == 0) return false;

				try {
					if (this.chat.active) {
						var target = this.chat.active.name;

						var vars = new psyc.Vars("_target", target);
					 
						var p = new psyc.Message( target.is_person() ? "_message_private" : "_message_public", vars, str);
						this.client.send(p);
						document.chat_input.text.value = "";
					} else {
						error_fun("You cannot chat to the DEBUG!");
					}
				} catch (err) {
					meteor.debug("send failed: ".err.toString());
				}
				return false;
			};

		</script>
		<style type="text/css">
			body {
				font-family: 'Andale Mono', sans-serif;
				margin: 0;
				margin-top: 10px;
				background: #ccc;
			}
                        
			#chathaven {
				margin: 0; 
			}

			div.header a {
				text-align: right;
			}

			div.toggler {
				font-size: 12px;
				font-family: 'Andale-Mono', sans-serif;
				display: inline;
			}

			div.error {
				font-family: monospace;
				font-size: small;
				height: 400px;
				color: black;
				overflow:auto;
			}

			div.roomchat {
				height: 300px;
				overflow: auto;
				border-bottom: 1px #ccc solid;	
			}

			div.privatechat {
				height: 400px;
				overflow: auto;
				border-bottom: 1px #ccc solid;	
			}

			div.chatwindow table {
				height: 100px;
				overflow: auto;
			}

			div.chatwindow {
				background-color: #dddddd;
				border-right: 1px #ccc solid;
				border-left: 1px #ccc solid;
			}

			div.left {
				background-color: #aaaaaa;
			}

			div.header {
				cursor: pointer;
				height: 25px;
				line-height: 25px;
				border-right: 1px #ccc solid;
				border-left: 1px #ccc solid;
				border-top: 1px #FFF solid;
				border-bottom: 1px #999 solid;
				font-family: 'Andale Mono', sans-serif;
				font-size: 12px;
				background: url(AccordionTab0.gif);
				color: #528CE0;
				margin: 0;
				padding: 3px 5px 1px;
			}

			blockquote {
				padding:5px 20px;
			}
			span._user_realname {
				color: #00f;
				font-variant: small-caps;
			}

			span._timestamp {
				color: #f00;
			}

			div._ {
			        padding-left: 5px;
				color: #000;
				font-size: 12px;
			}

			span._timestamp-_minutes {
				text-decoration: underline;
			}
			
			span._ {
				color: #990000;
			}
			
			span._message {
				color: #009900;
			}
			
			br.clearall {
				clear:both;
			}
			
			input.chattext {
				width: 95%;
			}
                        
			#container {
					width: 780px;
					position: relative;
					margin: 0px auto 0px auto;
					background: #fff;
					border: 1px solid #999;
			}
			
			#leftPane {
					width: 50%;
					position: relative;
					float:left;
			}
			
			#rightPane {
					width: 50%;
					position: relative;
					float:right;
			}
			
			#rooms {
					padding: 20px;
			}
			
			#basePane {
					height: 50px;
					background: #efefef;
					line-height: 50px;
					padding: 20px;
					clear:both;
			}
                        
                         #connect {
                                position: relative;
                                width: 500px;
                                padding: 10px;
                                margin-left: auto;
                                margin-right: auto;
                                background: #fff;
                                border: 2px solid #999;
                                -moz-border-radius: 10px;
                                -webkit-border-radius: 10px;
                                border-radius: 10px;
                        }
                        
                        
                        #connect input.textInput {
                        
                                height: 26px; 
                                width: 300px; 
                                font-size: 16pt; 
                        }
                        
                        #connect input.submitInput {
                                display: block;
                                height: 145px;
                        }
                        
                        #connectRequest
                        {
                                height: 145px;
                                line-height: 145px;
                                padding-left: 135px;
                        	background-image: url(images/yakitychat.png);
                        	background-repeat: no-repeat;
                        	background-position: left 0px;
                        	border: 1px solid red;
                        }
                        
                        #connectError {
                                position:absolute;
                                left:center;
                                top:5;
                                font-size: 10pt;
                                color: red;
                        }
                        
		</style>
</head>
<body>
<div id="container" style="visibility:hidden;">
        <div id="leftPane">
			<div id="rooms">
				<select name="chat_rooms" onchange='return chat.enterRoom(psyc.get_uniform(this.value))'>
					<option value="">Available Rooms</option>
				<emit source="chat_rooms">
					<option value="&_.uniform;">&_.name;</option>
				</emit>
				</select>
			</div>
        </div>
        <div id="rightPane">
			<div id="chathaven"></div>
        </div>
        <div id="basePane">
			<form name=chat_input onSubmit="return atom()">
				<input name=text value="" size="50" class="chattext">
			</form>
        </div>
        <div style="float:right;"></div>
        <div style="clear:right;"></div>
</div>
<div id="connect">
       <div id="connectError"></div>
       <div id="connectRequest">
                <form name="login" onSubmit="return init()">
                        <input name="name" value="Enter Nickname..." onclick="this.value=''" size="25" class="textInput"> 
                        <input type="image" src="images/yak.png" name="submit" class="submitInput">
                </form>
       </div> 
</div>
</body>
