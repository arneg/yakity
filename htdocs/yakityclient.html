<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
    	<title>chathaven</title>    
    
        <script src="js/utf8.js" type="text/javascript"></script>
        <script src="js/xss.js" type="text/javascript"></script>
        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/mapping.js" type="text/javascript"></script>
        <script src="js/meteor.js" type="text/javascript"></script>
        <script src="js/table.js" type="text/javascript"></script>
        <script src="js/serialization.js" type="text/javascript"></script>
        <script src="js/psyc.js" type="text/javascript"></script>
		<script src="mootools-1.2.3-core-nc.js" type="text/javascript"></script>
		<script src="mootools-1-1.2.3.1-more.js" type="text/javascript"></script>
        
        
		<script type="text/javascript">
			var client; 
			var error;
			var chat;
			var profiles;
			var userlist;

			function elink(name) {
				var a = document.createElement("a");
				a.href = "javascript:void(null)";
				a.appendChild((typeof(name) == "string") ? document.createTextNode(name) : name);
				return a;
			}

			function onconnect(success, uh) {
				client.onconnect = null;
				if (!success) {
					document.getElementById("connectError").appendChild(document.createTextNode(uh));
					client = null;
					return;
				} else {
					document.getElementById("connect").style.visibility = "hidden";
					document.getElementById("container").style.visibility = "visible";
				}

				var userlink = (function(type, key, value, m) {
					if (type) return value.render(type);
					if (value.is_person()) {
						var a = elink(profiles.getDisplayNode(value));
						a.onclick = function() {
							var win = chat.getWindow(value);
							chat.active = win;
							chat.accordion.display(win.pos);
						};
						return a;
					} else {
						return profiles.getDisplayNode(value);
					}
				});
				var templates = new psyc.Vars("_", "[_source] says: [data]",
									  "_status_circuit", "Welcome to the chat at [_source-_host].",
									  "_notice_enter", "[_supplicant] enters [_source].",
									  "_notice_leave", "[_supplicant] leaves [_source].",
									  "_message_public", "[_timestamp-_hours]:[_timestamp-_minutes]:[_timestamp-_seconds] [_source_relay]: [data]",
									  "_message_private", "[_timestamp-_hours]:[_timestamp-_minutes]:[_timestamp-_seconds] [_source]: [data]",
									  "_echo_message_public", "[_timestamp-_hours]:[_timestamp-_minutes]:[_timestamp-_seconds]  [_source_relay]: [data]",
									  "_echo_message_private", "[_timestamp-_hours]:[_timestamp-_minutes]:[_timestamp-_seconds] [data]",
									  "_source", userlink,
									  "_supplicant", userlink
										);
				profiles = new psyc.ProfileData(client);
				userlist = new psyc.UserList(client, profiles);
				document.getElementById("leftPane").appendChild(userlist.table.table);
				chat = new AccChat(client, templates);

				error = document.createElement("div");
				var errorh = document.createElement("div");
				var errorc = document.createElement("div");
				errorh.appendChild(document.createTextNode("DEBUG"));
				errorc.appendChild(error);
				UTIL.addClass(errorh, "header");
				UTIL.addClass(error, "error");
				document.getElementById("chathaven").appendChild(errorh);
				document.getElementById("chathaven").appendChild(errorc);
				chat.accordion.addSection(errorh, errorc, chat.accordion.elements.length);
				chat.accordion.display(0);
				error.style.overflow = "auto";
				meteor.debug = error_fun;
			}

			function init() {
				if (client) return false;

				var name = document.login.name.value;
				client = new psyc.Client("<meteorurl/>", name);
				client.onconnect = onconnect;
				return false;
			};

			function AccChat(client, templates) {
				psyc.Chat.call(this, client, templates);
				this.msg = function(m) {
					var ret = AccChat.prototype.msg.call(this, m);	
					var win = this.getWindow(m.vars.get("_source"));
					win.getMessagesNode().scrollTop = win.getMessagesNode().scrollHeight;
					return ret;
				};
				this.removeWindow = function(uniform) {
					var win = this.getWindow(uniform);
					this.accordion.togglers.splice(win.pos, 1);
					this.accordion.elements.splice(win.pos, 1);
					document.getElementById("chathaven").removeChild(win.header);
					document.getElementById("chathaven").removeChild(win.div);
					this.DOMtoWIN.remove(win.header.firstChild);

					if (this.active == win) {
						if (win.pos < this.accordion.elements.length) {
							this.active = this.DOMtoWIN.get(this.accordion.togglers[win.pos]);
							this.accordion.display(win.pos, false);
						} else if (win.pos > 0) {
							this.active = this.DOMtoWIN.get(this.accordion.togglers[win.pos-1]);
							this.accordion.display(win.pos-1, false);
						}
					}

					var messages = win.getMessages();

					for (var i = 0; i < messages.length; i++) {
						var id = messages[i].id();

						if (id != undefined) {
							messages[i] = id;	
						} else { // we assume that this wont happen often
							messages.splice(i, 1);
							i--;
						}
					}

					var m = new psyc.Message("_request_history_delete", { _messages : messages, _target : this.client.uniform });
					this.client.send(m);

					AccChat.prototype.removeWindow.call(this, uniform);
				};
				this.enterRoom = function(uniform) {
					AccChat.prototype.enterRoom.call(this, uniform);
					this.accordion.display(this.getWindow(uniform).pos);
				};
				this.createWindow = function(uniform) {
					var win;
					var toggler = document.createElement("div");
					UTIL.addClass(toggler, "toggler");

					if (uniform.is_person()) {
						win = new psyc.TemplatedWindow(templates, uniform);
						UTIL.addClass(win.getMessagesNode(), "privatechat");
					} else {
						win = new psyc.RoomWindow(templates, uniform);
						win.renderMember = function(uniform) {
							return profiles.getDisplayNode(uniform);
						};
						UTIL.addClass(win.getMessagesNode(), "roomchat");
					}
					var header = document.createElement("div");
					UTIL.addClass(header, "header");
					this.DOMtoWIN.set(toggler, win);
					toggler.appendChild(profiles.getDisplayNode(uniform));
					header.appendChild(toggler);

					if (uniform != chat.client.uniform) { // not the status window
						var a;
						if (uniform.is_person()) {
							a = elink("close");
							a.onclick = function() {
								chat.removeWindow(uniform);
							};
						} else {
							var b = elink("close");
							b.onclick = function() {
								var win = chat.getWindow(uniform);
								if (win.left) {
									chat.removeWindow(uniform);
								} else {
									chat.leaveRoom(uniform);
								}
							};
							header.appendChild(b);
							a = elink("leave");
							a.onclick = function() {
								chat.leaveRoom(uniform);
							};
						}
						header.appendChild(a);
					}

					var div = document.createElement("div");
					UTIL.addClass(div, "chatwindow");
					UTIL.addClass(win.getMessagesNode(), "messages");
					div.appendChild(win.getMessagesNode());

					if (uniform.is_room()) {
						div.appendChild(win.getMembersNode());
					}
					var pos = this.accordion.elements.length;
					document.getElementById("chathaven").appendChild(header);
					document.getElementById("chathaven").appendChild(div);
					this.accordion.addSection(toggler, div, pos);


					// fixes the flicker bug. dont know why mootools is fucking with the styles
					// at all.
					div.style.overflow = "auto";

					win.header = header;
					win.div = div;
					win.pos = pos;

					if (!this.active) {
						this.active = win;
						this.accordion.display(pos);
					}

					return win;
				};
				this.DOMtoWIN = new Mapping();
				this.templates = templates;
				this.active = undefined;
				var self = this;
				this.accordion = new Accordion(document.getElementById("chathaven"), 'a.toggler', 'div.chatwindow', {
					onActive: function(toggler, element){
						var chatwin = self.DOMtoWIN.get(toggler);
						if (chatwin && self.active != chatwin) {
							toggler.setStyle('color', '#41464D');
							
							self.active = chatwin;
							window.setTimeout((function(node) {
													chatwin.getMessagesNode().style.overflow="auto";
											  }), 700);
						} else if (!chatwin) {
							self.active = null;
						}

					},
					onBackground: function(toggler, element){
						toggler.setStyle('color', '#528CE0');
						var chatwin = self.DOMtoWIN.get(toggler);
						if (chatwin) chatwin.getMessagesNode().style.overflow="hidden";
					}
					//opacity : false
				});
			};
			AccChat.prototype = new psyc.Chat();
			AccChat.prototype.constructor = AccChat;


			function error_fun(str) {
				var text = document.createTextNode(str);
				error.appendChild(text);
				error.appendChild(document.createElement("br"));
				error.scrollTop = error.scrollHeight;
			};

			function atom() {
				var str = document.chat_input.text.value;
				if (str.length == 0) return false;

				try {
					if (this.chat.active) {
						var target = this.chat.active.name;

						var vars = new psyc.Vars("_target", target);
					 
						var p = new psyc.Message( target.is_person() ? "_message_private" : "_message_public", vars, str);
						this.client.send(p);
						document.chat_input.text.value = "";
					} else {
						error_fun("You cannot chat to the DEBUG!");
					}
				} catch (err) {
					meteor.debug("send failed: ".err.toString());
				}
				return false;
			};

			window.addEvent("domready", init);

		</script>
		<style type="text/css">
			body {
				font-family: 'Andale Mono', sans-serif;
				margin: 0;
				margin-top: 10px;
				background: #ccc;
			}
                        
			#chathaven {
				margin: 0; 
			}

			div.header a {
				text-align: right;
			}

			div.toggler {
				font-size: 12px;
				font-family: 'Andale-Mono', sans-serif;
				display: inline;
			}

			div.error {
				font-family: monospace;
				font-size: small;
				height: 400px;
				color: black;
				overflow:auto;
			}

			div.roomchat {
				height: 300px;
				overflow: auto;
				border-bottom: 1px #ccc solid;	
			}

			div.privatechat {
				height: 400px;
				overflow: auto;
				border-bottom: 1px #ccc solid;	
			}

			div.chatwindow table {
				height: 100px;
				overflow: auto;
			}

			div.chatwindow {
				background-color: #dddddd;
				border-right: 1px #ccc solid;
				border-left: 1px #ccc solid;
			}

			div.left {
				background-color: #aaaaaa;
			}

			div.header {
				cursor: pointer;
				height: 25px;
				line-height: 25px;
				border-right: 1px #ccc solid;
				border-left: 1px #ccc solid;
				border-top: 1px #FFF solid;
				border-bottom: 1px #999 solid;
				font-family: 'Andale Mono', sans-serif;
				font-size: 12px;
				background: url(AccordionTab0.gif);
				color: #528CE0;
				margin: 0;
				padding: 3px 5px 1px;
			}

			blockquote {
				padding:5px 20px;
			}
			span._user_realname {
				color: #00f;
				font-variant: small-caps;
			}

			span._timestamp {
				color: #f00;
			}

			div._ {
			        padding-left: 5px;
				color: #000;
				font-size: 12px;
			}

			span._timestamp-_minutes {
				text-decoration: underline;
			}
			
			span._ {
				color: #990000;
			}
			
			span._message {
				color: #009900;
			}
			
			br.clearall {
				clear:both;
			}
			
			input.chattext {
				width: 95%;
			}
                        
			#container {
					width: 780px;
					position: relative;
					margin: 0px auto 0px auto;
					background: #fff;
					border: 1px solid #999;
			}
			
			#leftPane {
					width: 50%;
					position: relative;
					float:left;
			}
			
			#rightPane {
					width: 50%;
					position: relative;
					float:right;
			}
			
			#rooms {
					padding: 20px;
			}
			
			#basePane {
					height: 50px;
					background: #efefef;
					line-height: 50px;
					padding: 20px;
					clear:both;
			}
                        
                        #connect {
                        
                        }
                        
                        #connectRequest
                        {
                        	background-image: url(images/yakitychat.png);
                        	background-repeat: no-repeat;
                        	background-position: left 10px;
                        }
                        
		</style>
</head>
<body>
<div id="container" style="visibility:hidden;">
        <div id="leftPane">
			<div id="rooms">
				<select name="chat_rooms" onchange='return chat.enterRoom(psyc.get_uniform(this.value))'>
					<option value="">Available Rooms</option>
				<emit source="chat_rooms">
					<option value="&_.uniform;">&_.name;</option>
				</emit>
				</select>
			</div>
        </div>
        <div id="rightPane">
			<div id="chathaven"></div>
        </div>
        <div id="basePane">
			<form name=chat_input onSubmit="return atom()">
				<input name=login value="" size="50" class="chattext">
			</form>
        </div>
        <div style="float:right;"></div>
        <div style="clear:right;"></div>
</div>
<div id="connect">
       <div id="connectRequest">
                <form name="login" onSubmit="return init()">
                        <input name="name" value="" size="25">
                </form>
                <div id="connectError"></div>
       </div> 
</div>
</body>
